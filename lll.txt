local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")

-- 玩家状态追踪系统核心 --
local PlayerTrackers = {
    Enabled = false,
    Trackers = {},
    Connections = {}
}

local HIGHLIGHT_SETTINGS = {
    FillColor = Color3.fromRGB(0, 170, 255),
    OutlineColor = Color3.fromRGB(0, 85, 127),
    DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
}

local TEXT_STYLE = {
    Font = Enum.Font.GothamBold,
    Size = 14,
    NameColor = Color3.new(1, 1, 1),         -- 新增姓名颜色
    HealthColor = Color3.fromRGB(255, 60, 60),
    DodgeColor = Color3.fromRGB(60, 255, 60)
}

local PlayerTracker = {}
PlayerTracker.__index = PlayerTracker

function PlayerTracker.new(player)
    if player == Players.LocalPlayer then
        return nil
    end
    
    local self = setmetatable({
        Player = player,
        Character = nil,
        Connections = {},
        UI = {
            Highlight = nil,
            Billboard = nil,
            NameLabel = nil,  -- 新增姓名标签
            HealthLabel = nil,
            DodgeLabel = nil
        },
        Active = true
    }, PlayerTracker)
    self:Initialize()
    return self
end

function PlayerTracker:Initialize()
    self:Connect("CharacterAdded", self.Player.CharacterAdded, function(char)
        self:TrackCharacter(char)
    end)
    if self.Player.Character then
        self:TrackCharacter(self.Player.Character)
    end
end

function PlayerTracker:TrackCharacter(character)
    if not character or character.Parent ~= workspace then
        return
    end

    self:Cleanup()

    self:Connect("AncestryChanged", character.AncestryChanged, function(_, parent)
        if not parent then
            task.wait(0.5)
            self:Cleanup()
        end
    end)

    -- 组件加载系统
    local humanoid, rootPart
    local loadAttempts = 0
    local maxAttempts = 50
    
    local function loadComponents()
        repeat
            humanoid = character:FindFirstChildWhichIsA("Humanoid")
            rootPart = character:FindFirstChild("HumanoidRootPart")
            loadAttempts += 1
            task.wait(0.1)
        until (humanoid and rootPart) or loadAttempts >= maxAttempts
    end
    
    loadComponents()
    
    if not humanoid then
        warn("角色组件加载失败："..self.Player.Name)
        return
    end

    -- 创建可视化元素
    if not self.UI.Highlight and character:IsDescendantOf(workspace) then
        -- 高光效果
        local highlight = Instance.new("Highlight")
        highlight.Name = "PlayerTrackerHighlight_"..self.Player.UserId
        highlight.FillColor = HIGHLIGHT_SETTINGS.FillColor
        highlight.OutlineColor = HIGHLIGHT_SETTINGS.OutlineColor
        highlight.DepthMode = HIGHLIGHT_SETTINGS.DepthMode
        highlight.Parent = character
        
        -- 状态显示面板
        local billboard = Instance.new("BillboardGui")
        billboard.Name = "PlayerTrackerUI_"..self.Player.UserId
        billboard.Size = UDim2.new(4, 0, 3, 0)  -- 调整为三行高度
        billboard.StudsOffset = Vector3.new(0, 3.5, 0)
        billboard.AlwaysOnTop = true
        billboard.Parent = character
        
        local container = Instance.new("Frame")
        container.Size = UDim2.new(1, 0, 1, 0)
        container.BackgroundTransparency = 1
        container.Parent = billboard

        -- 玩家姓名
        local nameLabel = Instance.new("TextLabel")
        nameLabel.Text = self.Player.Name
        nameLabel.Font = TEXT_STYLE.Font
        nameLabel.TextSize = TEXT_STYLE.Size + 2
        nameLabel.TextColor3 = TEXT_STYLE.NameColor
        nameLabel.Size = UDim2.new(1, 0, 0.3, 0)
        nameLabel.TextStrokeTransparency = 0.5
        nameLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
        nameLabel.Parent = container

        -- 生命值
        local healthLabel = Instance.new("TextLabel")
        healthLabel.Text = string.format("HP: %d/%d", humanoid.Health, humanoid.MaxHealth)
        healthLabel.Font = TEXT_STYLE.Font
        healthLabel.TextSize = TEXT_STYLE.Size
        healthLabel.TextColor3 = TEXT_STYLE.HealthColor
        healthLabel.Size = UDim2.new(1, 0, 0.35, 0)
        healthLabel.Position = UDim2.new(0, 0, 0.3, 0)
        healthLabel.Parent = container
        
        -- 闪避值
        local dodgeLabel = Instance.new("TextLabel")
        dodgeLabel.Text = "闪避: 检测中..."
        dodgeLabel.Font = TEXT_STYLE.Font
        dodgeLabel.TextSize = TEXT_STYLE.Size
        dodgeLabel.TextColor3 = TEXT_STYLE.DodgeColor
        dodgeLabel.Size = UDim2.new(1, 0, 0.35, 0)
        dodgeLabel.Position = UDim2.new(0, 0, 0.65, 0)
        dodgeLabel.Parent = container

        self.UI = {
            Highlight = highlight,
            Billboard = billboard,
            NameLabel = nameLabel,
            HealthLabel = healthLabel,
            DodgeLabel = dodgeLabel
        }
    end

    -- 数据绑定
    self:Connect("HealthChanged", humanoid.HealthChanged, function(health)
        self.UI.HealthLabel.Text = string.format("HP: %d/%d", health, humanoid.MaxHealth)
    end)
    
    -- 重生处理
    self:Connect("Died", humanoid.Died, function()
        self:Cleanup()
        local respawnConn
        respawnConn = self.Player.CharacterAdded:Connect(function(newChar)
            respawnConn:Disconnect()
            self:TrackCharacter(newChar)
        end)
        self.Connections.Respawn = respawnConn
    end)
    
    -- 闪避值追踪
    self:TrackDodgeValue(character, self.UI.DodgeLabel)
    
    self.Character = character
end

function PlayerTracker:TrackDodgeValue(character, dodgeLabel)
    local function FindDodge()
        return character:FindFirstChild("Dodges") 
            or character:FindFirstChild("DodgeValue")
            or self.Player:FindFirstChild("Dodges")
            or self.Player:FindFirstChild("DodgeValue")
    end
    
    local dodgeValue = FindDodge()
    if dodgeValue then
        self:UpdateDodgeDisplay(dodgeValue, dodgeLabel)
        return
    end
    
    local connections = {
        character.ChildAdded:Connect(function(child)
            if child.Name == "Dodges" or child.Name == "DodgeValue" then
                self:UpdateDodgeDisplay(child, dodgeLabel)
            end
        end),
        self.Player.ChildAdded:Connect(function(child)
            if child.Name == "Dodges" or child.Name == "DodgeValue" then
                self:UpdateDodgeDisplay(child, dodgeLabel)
            end
        end)
    }
    
    local heartbeat = RunService.Heartbeat:Connect(function()
        local found = FindDodge()
        if found then
            self:UpdateDodgeDisplay(found, dodgeLabel)
            heartbeat:Disconnect()
            for _, conn in pairs(connections) do conn:Disconnect() end
        end
    end)
    
    self.Connections.DodgeTracker = { connections[1], connections[2], heartbeat }
end

function PlayerTracker:UpdateDodgeDisplay(dodgeValue, dodgeLabel)
    dodgeLabel.Text = string.format("闪避: %d", dodgeValue.Value)
    self:Connect("DodgeChanged", dodgeValue.Changed, function(value)
        dodgeLabel.Text = string.format("闪避: %d", value)
    end)
end

function PlayerTracker:Connect(name, event, callback)
    local conn = event:Connect(callback)
    self.Connections[name] = conn
    return conn
end

function PlayerTracker:Cleanup()
    for _, conn in pairs(self.Connections) do
        if type(conn) == "table" then
            for _, subConn in pairs(conn) do pcall(subConn.Disconnect, subConn) end
        else
            pcall(conn.Disconnect, conn)
        end
    end
    self.Connections = {}
    
    if self.UI.Highlight then pcall(self.UI.Highlight.Destroy, self.UI.Highlight) end
    if self.UI.Billboard then pcall(self.UI.Billboard.Destroy, self.UI.Billboard) end
    self.UI = {}
end

function PlayerTracker:Destroy()
    self:Cleanup()
    self.Active = false
end

local function TogglePlayerTracking()
    PlayerTrackers.Enabled = not PlayerTrackers.Enabled
    
    if PlayerTrackers.Enabled then
        -- 添加延迟确保本地玩家排除
        task.wait(0.1)
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= Players.LocalPlayer then
                if not PlayerTrackers.Trackers[player] then
                    PlayerTrackers.Trackers[player] = PlayerTracker.new(player)
                end
            end
        end
        
        PlayerTrackers.Connections.PlayerAdded = Players.PlayerAdded:Connect(function(player)
            if player ~= Players.LocalPlayer then
                PlayerTrackers.Trackers[player] = PlayerTracker.new(player)
            end
        end)
    else
        -- 强化清理系统
        for player, tracker in pairs(PlayerTrackers.Trackers) do
            if tracker and tracker.Destroy then
                tracker:Destroy()
            end
        end
        table.clear(PlayerTrackers.Trackers)
        
        if PlayerTrackers.Connections.PlayerAdded then
            PlayerTrackers.Connections.PlayerAdded:Disconnect()
        end
    end
end

-- 原有代码保持不变，以下仅修改玩家状态切换部分 --
local Plr = Players.LocalPlayer
local SOUL_NAMES = {
    "Soul", "Dominus Rerum", "GoldIngot", "TCoin", "DSoul",
    "Rainbow Soul", "Dominus Azurelight",
    "Dominus Desperationis", "God's pillar", "Zent Orb", "Gift",
    "Familiar Head", "Hate Soul"
}

-- 全局控制变量
local isAutoCollecting = false
local collectLoop = nil

-- 模型处理核心函数
local function FindMovablePart(model)
    if model:IsA("Model") then
        return model.PrimaryPart or model:FindFirstChildWhichIsA("BasePart")
    end
    return model:IsA("BasePart") and model or nil
end

-- UI 创建函数（保持不变）
local function CreateAdvancedUI()
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "UltimateToolsUI_" .. HttpService:GenerateGUID(false)
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    ScreenGui.Parent = game.CoreGui

    -- 主容器
    local MainFrame = Instance.new("Frame")
    MainFrame.Size = UDim2.new(0, 320, 0, 300)
    MainFrame.Position = UDim2.new(0.5, -160, 0.5, -150)
    MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
    MainFrame.BorderSizePixel = 0
    MainFrame.ClipsDescendants = true
    MainFrame.Parent = ScreenGui

    -- 圆角处理
    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(0, 8)
    UICorner.Parent = MainFrame

    -- 标题栏
    local TitleBar = Instance.new("Frame")
    TitleBar.Size = UDim2.new(1, 0, 0, 36)
    TitleBar.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
    TitleBar.Parent = MainFrame

    local TitleText = Instance.new("TextLabel")
    TitleText.Text = "undertale timeline reset v6.1"
    TitleText.Font = Enum.Font.GothamBold
    TitleText.TextSize = 18
    TitleText.TextColor3 = Color3.fromRGB(200, 200, 210)
    TitleText.Size = UDim2.new(1, -100, 1, 0)
    TitleText.Position = UDim2.new(0, 15, 0, 0)
    TitleText.TextXAlignment = Enum.TextXAlignment.Left
    TitleText.Parent = TitleBar

    -- 控制按钮
    local ControlButtons = Instance.new("Frame")
    ControlButtons.Size = UDim2.new(0, 80, 1, 0)
    ControlButtons.Position = UDim2.new(1, -85, 0, 0)
    ControlButtons.BackgroundTransparency = 1
    ControlButtons.Parent = TitleBar

    local MinimizeButton = Instance.new("TextButton")
    MinimizeButton.Text = "-"
    MinimizeButton.Font = Enum.Font.GothamBold
    MinimizeButton.TextSize = 24
    MinimizeButton.Size = UDim2.new(0, 30, 0, 30)
    MinimizeButton.Position = UDim2.new(0, 0, 0.5, -15)
    MinimizeButton.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
    MinimizeButton.TextColor3 = Color3.fromRGB(200, 200, 210)
    MinimizeButton.Parent = ControlButtons

    local CloseButton = Instance.new("TextButton")
    CloseButton.Text = "×"
    CloseButton.Font = Enum.Font.GothamBold
    CloseButton.TextSize = 28
    CloseButton.Size = UDim2.new(0, 30, 0, 30)
    CloseButton.Position = UDim2.new(0, 40, 0.5, -15)
    CloseButton.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
    CloseButton.TextColor3 = Color3.fromRGB(240, 240, 240)
    CloseButton.Parent = ControlButtons

    -- 功能按钮容器
    local ButtonContainer = Instance.new("ScrollingFrame")
    ButtonContainer.Size = UDim2.new(1, -20, 1, -60)
    ButtonContainer.Position = UDim2.new(0, 10, 0, 40)
    ButtonContainer.BackgroundTransparency = 1
    ButtonContainer.ScrollBarThickness = 4
    ButtonContainer.AutomaticCanvasSize = Enum.AutomaticSize.Y
    ButtonContainer.Parent = MainFrame

    local UIListLayout = Instance.new("UIListLayout")
    UIListLayout.Padding = UDim.new(0, 12)
    UIListLayout.Parent = ButtonContainer

    -- 创建统一风格按钮
    local function CreateToolButton(text)
        local button = Instance.new("TextButton")
        button.Text = text
        button.Font = Enum.Font.GothamMedium
        button.TextSize = 16
        button.TextColor3 = Color3.fromRGB(220, 220, 230)
        button.Size = UDim2.new(1, 0, 0, 42)
        button.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
        button.AutoButtonColor = false

        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 6)
        corner.Parent = button

        -- 悬停动画
        button.MouseEnter:Connect(function()
            TweenService:Create(button, TweenInfo.new(0.15), {
                BackgroundColor3 = Color3.fromRGB(70, 70, 80),
                TextColor3 = Color3.fromRGB(240, 240, 250)
            }):Play()
        end)

        button.MouseLeave:Connect(function()
            TweenService:Create(button, TweenInfo.new(0.15), {
                BackgroundColor3 = Color3.fromRGB(50, 50, 60),
                TextColor3 = Color3.fromRGB(220, 220, 230)
            }):Play()
        end)

        return button
    end

    -- 添加功能按钮
    local AutoCollectButton = CreateToolButton("自动收集：关闭")
    AutoCollectButton.Parent = ButtonContainer

    local SnowpileButton = CreateToolButton("定位雪堆")
    SnowpileButton.Parent = ButtonContainer

    local PlayerStatsButton = CreateToolButton("玩家状态：关闭")
    PlayerStatsButton.Parent = ButtonContainer

    -- UI 交互逻辑
    local isMinimized = false
    MinimizeButton.MouseButton1Click:Connect(function()
        isMinimized = not isMinimized
        TweenService:Create(MainFrame, TweenInfo.new(0.3), {
            Size = isMinimized and UDim2.new(0, 320, 0, 36) or UDim2.new(0, 320, 0, 300)
        }):Play()
        ButtonContainer.Visible = not isMinimized
    end)

    CloseButton.MouseButton1Click:Connect(function()
        TweenService:Create(MainFrame, TweenInfo.new(0.3), {
            Size = UDim2.new(0, 0, 0, 0),
            Position = UDim2.new(0.5, 0, 0.5, 0)
        }):Play()
        task.wait(0.3)
        ScreenGui:Destroy()
    end)

    -- 触控拖动系统
    local dragging = false
    local dragStartPos, frameStartPos

    TitleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStartPos = input.Position
            frameStartPos = MainFrame.Position
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local delta = input.Position - dragStartPos
            MainFrame.Position = UDim2.new(
                frameStartPos.X.Scale,
                frameStartPos.X.Offset + delta.X,
                frameStartPos.Y.Scale,
                frameStartPos.Y.Offset + delta.Y
            )
        end
    end)

    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = false
        end
    end)

    return {
        AutoCollectButton = AutoCollectButton,
        SnowpileButton = SnowpileButton,
        PlayerStatsButton = PlayerStatsButton,
        MainFrame = MainFrame,
        ScreenGui = ScreenGui
    }
end

-- 初始化 UI
local AdvancedUI = CreateAdvancedUI()

-- 自动收集功能（保持不变）
local function StartAutoCollect()
    isAutoCollecting = true
    AdvancedUI.AutoCollectButton.Text = "自动收集：开启"
    TweenService:Create(AdvancedUI.AutoCollectButton, TweenInfo.new(0.2), {
        BackgroundColor3 = Color3.fromRGB(80, 180, 120)
    }):Play()

    collectLoop = RunService.Heartbeat:Connect(function()
        if not isAutoCollecting then return end

        local character = Plr.Character
        if not character then return end
        
        local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
        if not humanoidRootPart then return end

        local blacklistedFolder = workspace:FindFirstChild("Blacklisted")
        if not blacklistedFolder then return end

        local basePos = humanoidRootPart.Position + humanoidRootPart.CFrame.LookVector * 7 + Vector3.new(0, 3, 0)

        for _, obj in ipairs(blacklistedFolder:GetDescendants()) do
            task.spawn(function()
                -- 增强型对象检测
                local isTarget = false
                local lowerName = string.lower(obj.Name)
                for _, name in ipairs(SOUL_NAMES) do
                    if string.find(lowerName, string.lower(name)) then
                        isTarget = true
                        break
                    end
                end

                if isTarget then
                    local targetPart = FindMovablePart(obj)
                    if targetPart and not targetPart:IsDescendantOf(character) then
                        local original = {
                            parent = targetPart.Parent,
                            anchored = targetPart.Anchored
                        }
                        
                        -- 模型特殊处理
                        if obj:IsA("Model") then
                            targetPart.Anchored = true
                            targetPart.Parent = workspace
                        end
                        
                        targetPart.Anchored = true
                        targetPart.CFrame = CFrame.new(basePos + Vector3.new(
                            math.random(-4,4),
                            math.random(-2,2),
                            math.random(-4,4)
                        ))
                        
                        task.wait(0.5)
                        pcall(function()
                            targetPart.Anchored = original.anchored
                            targetPart.Parent = original.parent
                        end)
                    end
                end
            end)
        end
    end)
end

local function StopAutoCollect()
    isAutoCollecting = false
    if collectLoop then
        collectLoop:Disconnect()
    end
    AdvancedUI.AutoCollectButton.Text = "自动收集：关闭"
    TweenService:Create(AdvancedUI.AutoCollectButton, TweenInfo.new(0.2), {
        BackgroundColor3 = Color3.fromRGB(50, 50, 60)
    }):Play()
end

AdvancedUI.AutoCollectButton.MouseButton1Click:Connect(function()
    if isAutoCollecting then
        StopAutoCollect()
    else
        StartAutoCollect()
    end
end)

-- 雪堆定位功能（保持不变）
local function FindSnowPile()
    local blacklistedFolder = workspace:FindFirstChild("Blacklisted")
    if not blacklistedFolder then return nil end

    local snowNames = {"Snow Pile", "SnowPile", "snow_pile"}
    for _, name in ipairs(snowNames) do
        local pile = blacklistedFolder:FindFirstChild(name)
        if pile then
            local targetPart = FindMovablePart(pile)
            return targetPart or pile:IsA("Model") and pile:GetChildren()[1]
        end
    end
    return nil
end

AdvancedUI.SnowpileButton.MouseButton1Click:Connect(function()
    local character = Plr.Character
    if not character then return end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return end

    local snowPile = FindSnowPile()
    if snowPile then
        TweenService:Create(humanoidRootPart, TweenInfo.new(1.5, Enum.EasingStyle.Quad), {
            CFrame = snowPile.CFrame + Vector3.new(0, 5, 0)
        }):Play()
        
        -- 按钮反馈
        TweenService:Create(AdvancedUI.SnowpileButton, TweenInfo.new(0.2), {
            BackgroundColor3 = Color3.fromRGB(100, 150, 200)
        }):Play()
        task.wait(0.2)
        TweenService:Create(AdvancedUI.SnowpileButton, TweenInfo.new(0.2), {
            BackgroundColor3 = Color3.fromRGB(50, 50, 60)
        }):Play()
    else
        warn("未找到雪堆!")
    end
end)

-- 修改玩家状态切换绑定
AdvancedUI.PlayerStatsButton.MouseButton1Click:Connect(function()
    TogglePlayerTracking()
    local enabled = PlayerTrackers.Enabled
    AdvancedUI.PlayerStatsButton.Text = enabled and "玩家状态：开启" or "玩家状态：关闭"
    
    -- 添加状态确认机制
    task.wait(0.2)
    if enabled then
        -- 二次检查本地玩家跟踪
        for player in pairs(PlayerTrackers.Trackers) do
            if player == Plr then
                PlayerTrackers.Trackers[player]:Destroy()
            end
        end
    end
    
    TweenService:Create(AdvancedUI.PlayerStatsButton, TweenInfo.new(0.2), {
        BackgroundColor3 = enabled and Color3.fromRGB(80, 120, 200) or Color3.fromRGB(50, 50, 60)
    }):Play()
end)